<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vago Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Screen */
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .login-title {
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: none;
            background: #f5f7fa;
            min-height: 100vh;
            width: 100vw;
        }

        .admin-header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-logo-icon {
            font-size: 32px;
            color: #667eea;
        }

        .admin-logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-user-name {
            font-weight: 600;
            color: #333;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .admin-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .admin-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e1e1e1;
            padding: 30px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 5px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 30px;
            color: #666;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #f8f9ff;
            color: #667eea;
            border-right-color: #667eea;
        }

        .sidebar-nav i {
            width: 20px;
            font-size: 18px;
        }

        .admin-main {
            flex: 1;
            padding: 40px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
        }

        .content-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #457b9d;
            outline: none;
            box-shadow: 0 0 0 3px rgba(69, 123, 157, 0.1);
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        button {
            background-color: #457b9d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #3a6a8a;
            transform: translateY(-1px);
        }

        .trip-list {
            margin-top: 40px;
        }

        .trip-list h2 {
            color: #1a1a1a;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .trip-item {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e1e1e1;
            transition: all 0.3s ease;
            position: relative;
        }

        .trip-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .trip-item h3 {
            color: #1a1a1a;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .trip-item p {
            color: #555;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .trip-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            margin: 0;
        }

        .edit-button {
            background-color: #4CAF50;
        }

        .edit-button:hover {
            background-color: #45a049;
        }

        .delete-button {
            background-color: #f44336;
        }

        .delete-button:hover {
            background-color: #da190b;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        .difficulty-easy {
            background-color: #4CAF50;
            color: white;
        }

        .difficulty-medium {
            background-color: #FF9800;
            color: white;
        }

        .difficulty-hard {
            background-color: #f44336;
            color: white;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
            background-color: #457b9d;
            color: white;
        }

        /* Style pour les textes d'aide */
        .form-help {
            display: block;
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }

        /* Emp√™cher le d√©filement de la page quand le modal est ouvert */
        body.modal-open {
            overflow: hidden;
        }
        
        /* Styles pour les √©v√©nements */
        .event-item {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid #e0e0e0;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .event-title {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .remove-event {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .event-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .secondary-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
            display: inline-block;
        }

        /* Styles pour les demandes de r√©compenses */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .filter-button {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e1e1e1;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 0;
            width: auto;
        }

        .filter-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-button:hover {
            transform: translateY(-1px);
        }

        .claim-item {
            background: white;
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .claim-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .claim-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .claim-status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .claim-status-approved {
            background: #d1edff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .claim-status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .claim-status-in_preparation {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .claim-status-shipped {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .claim-status-delivered {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .claim-reward-summary {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .claim-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .claim-info-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .claim-info-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .claim-info-value {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .claim-actions {
            display: flex;
            gap: 8px;
        }

        .claim-quick-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #667eea;
        }

        .claim-quick-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-logo">üöó</div>
        <h1 class="login-title">Vago Admin</h1>
        <p class="login-subtitle">Connectez-vous pour acc√©der au panel d'administration</p>
        
        <div id="loginError" class="login-error"></div>
        
        <form id="loginForm">
            <input type="email" id="loginEmail" class="login-input" placeholder="Email" required>
            <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" required>
            <button type="submit" class="login-button">Se connecter</button>
        </form>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-logo">
                <i class="fas fa-car admin-logo-icon"></i>
                <span class="admin-logo-text">Vago Admin</span>
            </div>
            <div class="admin-user-info">
                <span class="admin-user-name" id="currentUserName">Admin</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Sidebar -->
            <nav class="admin-sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" onclick="showTab('dashboard')" class="active" id="dashboardTab">
                        <i class="fas fa-tachometer-alt"></i> Tableau de bord
                    </a></li>
                    <li><a href="#" onclick="showTab('trips')" id="tripsTab">
                        <i class="fas fa-route"></i> Trajets
                    </a></li>
                    <li><a href="#" onclick="showTab('items')" id="itemsTab">
                        <i class="fas fa-box"></i> Objets
                    </a></li>
                    <li><a href="#" onclick="showTab('rewards')" id="rewardsTab">
                        <i class="fas fa-gift"></i> R√©compenses
                    </a></li>
                    <li><a href="#" onclick="showTab('reward-claims')" id="rewardClaimsTab">
                        <i class="fas fa-hands"></i> Demandes de r√©compenses
                    </a></li>
                    <li><a href="#" onclick="showTab('appSettings')" id="appSettingsTab">
                        <i class="fas fa-cogs"></i> Param√®tres App
                    </a></li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="admin-main">
                <div id="successMessage" class="success-message"></div>
                <div id="errorMessage" class="error-message"></div>

                <!-- Dashboard Tab -->
                <div id="dashboardContent" class="tab-content">
                    <div class="page-header">
                        <h2 class="page-title">Tableau de bord</h2>
                        <p class="page-subtitle">Vue d'ensemble de votre application Vago</p>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-chart-bar"></i>
                            Statistiques rapides
                        </h3>
                        <div id="dashboardStats">Chargement des statistiques...</div>
                    </div>
                </div>

                <!-- Trips Tab -->
                <div id="tripsContent" class="tab-content" style="display: none;">
                    <div class="page-header">
                        <h2 class="page-title">Gestion des Trajets</h2>
                        <p class="page-subtitle">Cr√©ez et g√©rez les trajets disponibles dans l'application</p>
                    </div>

                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-plus"></i>
                            Ajouter un nouveau trajet
                        </h3>
                        <form id="tripForm">
            <div class="form-group">
                <label for="title">Titre du trajet</label>
                <input type="text" id="title" required>
            </div>

            <div class="form-group">
                <label for="type">Type de trajet</label>
                <select id="type" required>
                    <option value="food">Repas</option>
                    <option value="package">Colis</option>
                    <option value="document">Document</option>
                </select>
            </div>

            <div class="form-group">
                <label for="from">Point de d√©part</label>
                <input type="text" id="from" required>
            </div>

            <div class="form-group">
                <label for="fromCoordinates">Coordonn√©es GPS de d√©part (lat, lng)</label>
                <input type="text" id="fromCoordinates" placeholder="Ex: 48.8566, 2.3522" required>
                <small class="form-help">Format: latitude, longitude (ex: 48.8566, 2.3522 pour Paris)</small>
            </div>

            <div class="form-group">
                <label for="to">Point d'arriv√©e</label>
                <input type="text" id="to" required>
            </div>

            <div class="form-group">
                <label for="toCoordinates">Coordonn√©es GPS d'arriv√©e (lat, lng)</label>
                <input type="text" id="toCoordinates" placeholder="Ex: 43.2965, 5.3698" required>
                <small class="form-help">Format: latitude, longitude (ex: 43.2965, 5.3698 pour Marseille)</small>
            </div>

            <div class="form-group">
                <label for="distance">Distance (km)</label>
                <input type="number" id="distance" step="0.1" required>
            </div>

            <div class="form-group">
                <label for="duration">Dur√©e (minutes)</label>
                <input type="number" id="duration" required>
                <span class="form-help">La dur√©e du trajet en minutes. Utilis√©e pour calculer l'heure d'arriv√©e pr√©vue.</span>
            </div>


            <div class="form-group">
                <label for="reward">R√©compense (miles)</label>
                <input type="number" id="reward" required>
            </div>

            <div class="form-group">
                <label for="difficulty">Difficult√©</label>
                <select id="difficulty" required>
                    <option value="easy">Facile</option>
                    <option value="medium">Moyen</option>
                    <option value="hard">Difficile</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" required></textarea>
            </div>

            <div class="form-group">
                <label for="tripImageFile">Image du trajet</label>
                <input type="file" id="tripImageFile" accept="image/*" style="margin-bottom: 10px;">
                <div id="imagePreview" style="display: none; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center;">
                    <img id="previewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
                    <p id="previewText" style="margin: 10px 0 0 0; font-size: 14px; color: #666;"></p>
                </div>
                <small class="form-help">S√©lectionnez une image qui repr√©sente ce qui est transport√© (optionnel)</small>
            </div>


            <div class="form-group">
                <label>√âv√©nements du trajet</label>
                <div id="eventsContainer">
                    <!-- Les √©v√©nements seront ajout√©s ici dynamiquement -->
                </div>
                <button type="button" id="addEventButton" class="secondary-button">Ajouter un √©v√©nement</button>
            </div>

            <button type="submit" id="submitButton">Ajouter le trajet</button>
                        </form>
                    </div>

                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            Trajets existants
                        </h3>
                        <div id="tripList"></div>
                    </div>
                </div>

                <!-- Items Tab -->
                <div id="itemsContent" class="tab-content" style="display: none;">
                    <div class="page-header">
                        <h2 class="page-title">Gestion des Objets</h2>
                        <p class="page-subtitle">G√©rez les objets disponibles dans le jeu</p>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-magic"></i>
                            Actions rapides
                        </h3>
                        <button class="init-button" onclick="initializeBaseItems()">
                            <i class="fas fa-rocket"></i> Initialiser les objets de base
                        </button>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            Objets existants
                        </h3>
                        <div id="itemList"></div>
                    </div>
                </div>

                <!-- Rewards Tab -->
                <div id="rewardsContent" class="tab-content" style="display: none;">
                    <div class="page-header">
                        <h2 class="page-title">Gestion des R√©compenses</h2>
                        <p class="page-subtitle">Configurez les r√©compenses disponibles pour les joueurs</p>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-magic"></i>
                            Actions rapides
                        </h3>
                        <button class="init-button" onclick="initializeDefaultRewards()">
                            <i class="fas fa-trophy"></i> Initialiser les r√©compenses par d√©faut
                        </button>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-plus"></i>
                            Ajouter une nouvelle r√©compense
                        </h3>
                        <form id="rewardForm">
                            <div class="form-group">
                                <label for="rewardTitle">Titre de la r√©compense</label>
                                <input type="text" id="rewardTitle" required placeholder="Ex: RECOMPENSE BRONZE">
                            </div>
                            <div class="form-group">
                                <label for="rewardSubtitle">Sous-titre</label>
                                <input type="text" id="rewardSubtitle" required placeholder="Ex: D√©bloquez cette r√©compense exclusive">
                            </div>
                            <div class="form-group">
                                <label for="rewardDescription">Description</label>
                                <textarea id="rewardDescription" required placeholder="Description d√©taill√©e de la r√©compense..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="rewardCost">Co√ªt en points</label>
                                <input type="number" id="rewardCost" required min="1" placeholder="200">
                            </div>
                            <div class="form-group">
                                <label for="rewardImageUrl">URL de l'image (optionnel)</label>
                                <input type="url" id="rewardImageUrl" placeholder="https://...">
                            </div>
                            <button type="submit" id="rewardSubmitButton">Ajouter la r√©compense</button>
                        </form>
                    </div>
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            R√©compenses existantes
                        </h3>
                        <div id="rewardsList"></div>
                    </div>
                </div>

                <!-- Reward Claims Tab -->
                <div id="reward-claimsContent" class="tab-content" style="display: none;">
                    <div class="page-header">
                        <h2 class="page-title">Gestion des Demandes de R√©compenses</h2>
                        <p class="page-subtitle">G√©rez toutes les demandes de r√©compenses des utilisateurs</p>
                    </div>
                    
                    <!-- Statistiques des demandes -->
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-chart-pie"></i>
                            Statistiques des demandes
                        </h3>
                        <div id="rewardClaimStats">Chargement des statistiques...</div>
                    </div>

                    <!-- Filtres par statut -->
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-filter"></i>
                            Filtrer par statut
                        </h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="filter-button active" onclick="filterClaimsByStatus('all')" id="filterAll">
                                Toutes
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('pending')" id="filterPending">
                                En attente
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('approved')" id="filterApproved">
                                Approuv√©es
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('rejected')" id="filterRejected">
                                Rejet√©es
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('in_preparation')" id="filterInPreparation">
                                En pr√©paration
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('shipped')" id="filterShipped">
                                Exp√©di√©es
                            </button>
                            <button class="filter-button" onclick="filterClaimsByStatus('delivered')" id="filterDelivered">
                                Livr√©es
                            </button>
                        </div>
                    </div>

                    <!-- Liste des demandes -->
                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-list"></i>
                            Demandes de r√©compenses
                        </h3>
                        <div id="rewardClaimsList">Chargement...</div>
                    </div>
                </div>

                <!-- App Settings Tab -->
                <div id="appSettingsContent" class="tab-content" style="display: none;">
                    <div class="page-header">
                        <h2 class="page-title">Param√®tres de l'Application</h2>
                        <p class="page-subtitle">G√©rez les param√®tres globaux de Vago</p>
                    </div>

                    <div class="content-card">
                        <h3 class="section-title">
                            <i class="fas fa-tools"></i>
                            Mode Maintenance
                        </h3>
                        <div class="form-group">
                            <label>Statut actuel</label>
                            <div id="maintenanceStatus" style="padding: 15px; border-radius: 8px; font-weight: 500;">Chargement...</div>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceDuration">Dur√©e estim√©e de la maintenance</label>
                            <input type="text" id="maintenanceDuration" placeholder="Ex: 2 heures, 30 minutes...">
                            <small class="form-help">Ce texte sera affich√© aux utilisateurs sur l'√©cran de maintenance.</small>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button onclick="setMaintenance(true)" style="background-color: #f44336; flex: 1;">
                                <i class="fas fa-power-off"></i> Activer la Maintenance
                            </button>
                            <button onclick="setMaintenance(false)" style="background-color: #4CAF50; flex: 1;">
                                <i class="fas fa-check-circle"></i> D√©sactiver la Maintenance
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal pour l'√©dition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2>Modifier le trajet</h2>
            <form id="editForm">
                <input type="hidden" id="editTripId">
                <div class="form-group">
                    <label for="editTitle">Titre du trajet</label>
                    <input type="text" id="editTitle" required>
                </div>

                <div class="form-group">
                    <label for="editType">Type de trajet</label>
                    <select id="editType" required>
                        <option value="food">Repas</option>
                        <option value="package">Colis</option>
                        <option value="document">Document</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editFrom">Point de d√©part</label>
                    <input type="text" id="editFrom" required>
                </div>

                <div class="form-group">
                    <label for="editFromCoordinates">Coordonn√©es GPS de d√©part (lat, lng)</label>
                    <input type="text" id="editFromCoordinates" placeholder="Ex: 48.8566, 2.3522" required>
                    <small class="form-help">Format: latitude, longitude (ex: 48.8566, 2.3522 pour Paris)</small>
                </div>

                <div class="form-group">
                    <label for="editTo">Point d'arriv√©e</label>
                    <input type="text" id="editTo" required>
                </div>

                <div class="form-group">
                    <label for="editToCoordinates">Coordonn√©es GPS d'arriv√©e (lat, lng)</label>
                    <input type="text" id="editToCoordinates" placeholder="Ex: 43.2965, 5.3698" required>
                    <small class="form-help">Format: latitude, longitude (ex: 43.2965, 5.3698 pour Marseille)</small>
                </div>

                <div class="form-group">
                    <label for="editDistance">Distance (km)</label>
                    <input type="number" id="editDistance" step="0.1" required>
                </div>

                <div class="form-group">
                    <label for="editDuration">Dur√©e (minutes)</label>
                    <input type="number" id="editDuration" required>
                </div>


                <div class="form-group">
                    <label for="editReward">R√©compense (miles)</label>
                    <input type="number" id="editReward" required>
                </div>

                <div class="form-group">
                    <label for="editDifficulty">Difficult√©</label>
                    <select id="editDifficulty" required>
                        <option value="easy">Facile</option>
                        <option value="medium">Moyen</option>
                        <option value="hard">Difficile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" required></textarea>
                </div>

                <div class="form-group">
                    <label for="editTripImageFile">Image du trajet</label>
                    <input type="file" id="editTripImageFile" accept="image/*" style="margin-bottom: 10px;">
                    <div id="editImagePreview" style="display: none; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center;">
                        <img id="editPreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
                        <p id="editPreviewText" style="margin: 10px 0 0 0; font-size: 14px; color: #666;"></p>
                    </div>
                    <div id="editCurrentImage" style="display: none; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center;">
                        <p style="margin: 0 0 10px 0; font-size: 14px; color: #333; font-weight: 500;">Image actuelle:</p>
                        <img id="currentImg" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
                    </div>
                    <small class="form-help">S√©lectionnez une nouvelle image pour remplacer l'existante (optionnel)</small>
                </div>

                <div class="form-group">
                    <label>√âv√©nements du trajet</label>
                    <div id="editEventsContainer">
                        <!-- Les √©v√©nements seront ajout√©s ici dynamiquement -->
                    </div>
                    <button type="button" id="editAddEventButton" class="secondary-button">Ajouter un √©v√©nement</button>
                </div>

                <button type="submit">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <!-- Modal pour √©diter le statut des demandes -->
    <div id="editRewardClaimModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRewardClaimModal()">&times;</span>
            <h2>Modifier le statut de la demande</h2>
            <form id="rewardClaimStatusForm">
                <input type="hidden" id="editClaimId">
                
                <div class="form-group">
                    <label for="claimUserInfo">Utilisateur</label>
                    <div id="claimUserInfo" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-weight: 500;"></div>
                </div>

                <div class="form-group">
                    <label for="claimRewardInfo">R√©compense demand√©e</label>
                    <div id="claimRewardInfo" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-weight: 500;"></div>
                </div>

                <div class="form-group">
                    <label for="claimPersonalInfo">Informations de livraison</label>
                    <div id="claimPersonalInfo" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px; line-height: 1.4;"></div>
                </div>

                <div class="form-group">
                    <label for="editClaimStatus">Nouveau statut</label>
                    <select id="editClaimStatus" required>
                        <option value="pending">En attente</option>
                        <option value="approved">Approuv√©e</option>
                        <option value="rejected">Rejet√©e</option>
                        <option value="in_preparation">En pr√©paration</option>
                        <option value="shipped">Exp√©di√©e</option>
                        <option value="delivered">Livr√©e</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editClaimNotes">Notes administratives (optionnel)</label>
                    <textarea id="editClaimNotes" placeholder="Raison du rejet, num√©ro de suivi, etc."></textarea>
                </div>

                <button type="submit">Mettre √† jour le statut</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK avec Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>

    <script>
        // Variables globales pour les √©v√©nements
        let tripEvents = [];
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDBfSRT-1wb2uZyE27KH9CTBMPEohR9eb0",
            authDomain: "vago-7aba9.firebaseapp.com",
            projectId: "vago-7aba9",
            storageBucket: "vago-7aba9.firebasestorage.app",
            messagingSenderId: "785414702747",
            appId: "1:785414702747:web:a8907450856db88a3ce83e",
            measurementId: "G-K50H4X4V5Z"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Variables globales
        let currentUser = null;
        let currentTripImageFile = null;
        let editTripImageFile = null;

        // Gestion de la pr√©visualisation d'image pour l'ajout
        document.getElementById('tripImageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentTripImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('previewText').textContent = `Image s√©lectionn√©e: ${file.name}`;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
                currentTripImageFile = null;
            }
        });

        // Gestion de la pr√©visualisation d'image pour l'√©dition
        document.getElementById('editTripImageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                editTripImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editPreviewText').textContent = `Nouvelle image: ${file.name}`;
                    document.getElementById('editImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
                editTripImageFile = null;
            }
        });

        // Fonction pour uploader une image vers Firebase Storage
        async function uploadTripImage(file, tripId) {
            if (!file) return null;

            try {
                const fileName = `trip-images/${tripId}_${Date.now()}_${file.name}`;
                const storageRef = storage.ref(fileName);

                showMessage('Upload de l\'image en cours...', 'success');

                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                console.log('Image upload√©e avec succ√®s:', downloadURL);
                return downloadURL;
            } catch (error) {
                console.error('Erreur lors de l\'upload:', error);
                showMessage('Erreur lors de l\'upload de l\'image: ' + error.message, 'error');
                return null;
            }
        }

        // Authentification
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById('loginError').textContent = 'Erreur de connexion: ' + error.message;
                document.getElementById('loginError').style.display = 'block';
            }
        });

        // √âcouter les changements d'authentification
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('currentUserName').textContent = user.email;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadDashboard();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminDashboard').style.display = 'none';
            }
        });

        // D√©connexion
        function logout() {
            auth.signOut();
        }

        // Navigation des onglets
        function showTab(tabName) {
            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Supprimer la classe active de tous les liens
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Afficher le contenu s√©lectionn√©
            document.getElementById(tabName + 'Content').style.display = 'block';
            
            // G√©rer l'ID du tab avec le tiret
            const tabId = tabName === 'reward-claims' ? 'rewardClaimsTab' : (tabName === 'appSettings' ? 'appSettingsTab' : tabName + 'Tab');
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Charger les donn√©es appropri√©es
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'trips':
                    loadTrips();
                    break;
                case 'items':
                    loadItems();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
                case 'reward-claims':
                    loadRewardClaims();
                    break;
                case 'appSettings':
                    loadMaintenanceStatus();
                    break;
            }
        }

        // Charger le dashboard
        async function loadDashboard() {
            try {
                const [tripsSnapshot, itemsSnapshot, rewardsSnapshot] = await Promise.all([
                    db.collection('trips').get(),
                    db.collection('items').get(),
                    db.collection('rewards').get()
                ]);
                
                const statsHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: #667eea; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <h3 style="font-size: 32px; margin-bottom: 5px;">${tripsSnapshot.size}</h3>
                            <p>Trajets</p>
                        </div>
                        <div style="background: #4CAF50; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <h3 style="font-size: 32px; margin-bottom: 5px;">${itemsSnapshot.size}</h3>
                            <p>Objets</p>
                        </div>
                        <div style="background: #FF9800; color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <h3 style="font-size: 32px; margin-bottom: 5px;">${rewardsSnapshot.size}</h3>
                            <p>R√©compenses</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('dashboardStats').innerHTML = statsHtml;
            } catch (error) {
                document.getElementById('dashboardStats').innerHTML = 'Erreur lors du chargement des statistiques.';
            }
        }

        async function loadMaintenanceStatus() {
            const statusDiv = document.getElementById('maintenanceStatus');
            const durationInput = document.getElementById('maintenanceDuration');
            try {
                const doc = await db.collection('app_status').doc('maintenance').get();
                if (doc.exists && doc.data().isActive) {
                    statusDiv.innerHTML = `MAINTENANCE ACTIVE - Dur√©e: ${doc.data().estimatedDuration || 'Non d√©finie'}`;
                    statusDiv.style.backgroundColor = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    durationInput.value = doc.data().estimatedDuration || '';
                } else {
                    statusDiv.innerHTML = 'MAINTENANCE INACTIVE';
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    durationInput.value = '';
                }
            } catch (error) {
                statusDiv.innerHTML = 'Erreur lors de la r√©cup√©ration du statut.';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
            }
        }

        async function setMaintenance(isActive) {
            const duration = document.getElementById('maintenanceDuration').value;
            if (isActive && !duration) {
                showMessage('Veuillez sp√©cifier une dur√©e pour la maintenance.', 'error');
                return;
            }
            
            try {
                const maintenanceData = {
                    isActive: isActive,
                    estimatedDuration: isActive ? duration : ''
                };
                await db.collection('app_status').doc('maintenance').set(maintenanceData, { merge: true });
                showMessage(`Maintenance ${isActive ? 'activ√©e' : 'd√©sactiv√©e'} avec succ√®s !`, 'success');
                loadMaintenanceStatus();
            } catch (error) {
                showMessage('Erreur lors de la mise √† jour du statut de maintenance : ' + error.message, 'error');
            }
        }

        let currentTripId = null;
        let currentRewardId = null;

        // Fonction pour ajouter un √©v√©nement au formulaire
        document.getElementById('addEventButton').addEventListener('click', function() {
            addEventToForm();
        });
        
        // Fonction pour ajouter un √©v√©nement au formulaire
        function addEventToForm(eventData = null) {
            const eventsContainer = document.getElementById('eventsContainer');
            const eventId = eventData?.eventId || uuidv4();
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.dataset.eventId = eventId;
            
            const eventContent = `
                <div class="event-header">
                    <span class="event-title">√âv√©nement</span>
                    <button type="button" class="remove-event">Supprimer</button>
                </div>
                <div class="event-fields">
                    <div>
                        <label for="event-title-${eventId}">Titre</label>
                        <input type="text" id="event-title-${eventId}" class="event-title-input" value="${eventData?.title || ''}" placeholder="Ex: Bouchon, Route barr√©e, etc." required>
                    </div>
                    <div>
                        <label for="event-timing-${eventId}">D√©lai apr√®s d√©part (minutes)</label>
                        <input type="number" id="event-timing-${eventId}" class="event-timing-input" value="${eventData?.timing || '30'}" min="0" required>
                    </div>
                    <div>
                        <label for="event-type-${eventId}">Type</label>
                        <select id="event-type-${eventId}" class="event-type-input">
                            <option value="fixed" ${eventData?.type === 'fixed' ? 'selected' : ''}>Fixe</option>
                            <option value="random" ${eventData?.type === 'random' ? 'selected' : ''}>Al√©atoire</option>
                        </select>
                    </div>
                    <div>
                        <label for="event-category-${eventId}">Cat√©gorie</label>
                        <select id="event-category-${eventId}" class="event-category-input">
                            <option value="general" ${!eventData?.category || eventData?.category === 'general' ? 'selected' : ''}>G√©n√©ral</option>
                            <option value="bouchon" ${eventData?.category === 'bouchon' ? 'selected' : ''}>Bouchon</option>
                            <option value="pluie" ${eventData?.category === 'pluie' ? 'selected' : ''}>Pluie</option>
                            <option value="route-barree" ${eventData?.category === 'route-barree' ? 'selected' : ''}>Route barr√©e</option>
                            <option value="colis-mystere" ${eventData?.category === 'colis-mystere' ? 'selected' : ''}>Colis myst√®re</option>
                            <option value="pause-fatigue" ${eventData?.category === 'pause-fatigue' ? 'selected' : ''}>Pause fatigue</option>
                            <option value="pneu-creve" ${eventData?.category === 'pneu-creve' ? 'selected' : ''}>Pneu crev√©</option>
                            <option value="controle-police" ${eventData?.category === 'controle-police' ? 'selected' : ''}>Contr√¥le de police</option>
                            <option value="feu-rouge" ${eventData?.category === 'feu-rouge' ? 'selected' : ''}>Feu rouge</option>
                            <option value="radar" ${eventData?.category === 'radar' ? 'selected' : ''}>Radar</option>
                            <option value="panneaux" ${eventData?.category === 'panneaux' ? 'selected' : ''}>Panneaux routiers</option>
                            <option value="peage" ${eventData?.category === 'peage' ? 'selected' : ''}>P√©age automatique</option>
                            <option value="radio" ${eventData?.category === 'radio' ? 'selected' : ''}>Radio</option>
                        </select>
                    </div>
                </div>
            `;
            
            eventItem.innerHTML = eventContent;
            eventsContainer.appendChild(eventItem);
            
            // Ajouter l'√©couteur d'√©v√©nement pour le bouton de suppression
            eventItem.querySelector('.remove-event').addEventListener('click', function() {
                eventItem.remove();
            });
        }
        
        // Fonction pour collecter les √©v√©nements du formulaire
        function collectEvents() {
            const events = [];
            const eventItems = document.querySelectorAll('.event-item');
            
            eventItems.forEach(item => {
                const eventId = item.dataset.eventId;
                const title = item.querySelector('.event-title-input').value;
                const timing = parseInt(item.querySelector('.event-timing-input').value);
                const type = item.querySelector('.event-type-input').value;
                const category = item.querySelector('.event-category-input').value;
                
                events.push({
                    eventId,
                    title,
                    timing,
                    type,
                    category
                });
            });
            
            return events;
        }
        
        // Gestion du formulaire d'ajout
        document.getElementById('tripForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Parse GPS coordinates
            const fromCoordsInput = document.getElementById('fromCoordinates').value;
            const toCoordsInput = document.getElementById('toCoordinates').value;
            
            // Validation des coordonn√©es GPS
            if (!fromCoordsInput || !toCoordsInput) {
                showMessage('Veuillez entrer des coordonn√©es GPS valides pour les points de d√©part et d\'arriv√©e', 'error');
                return;
            }
            
            const fromCoords = fromCoordsInput.split(',').map(coord => parseFloat(coord.trim()));
            const toCoords = toCoordsInput.split(',').map(coord => parseFloat(coord.trim()));
            
            // V√©rifier que les coordonn√©es sont des nombres valides
            if (fromCoords.length !== 2 || toCoords.length !== 2 || 
                isNaN(fromCoords[0]) || isNaN(fromCoords[1]) || 
                isNaN(toCoords[0]) || isNaN(toCoords[1])) {
                showMessage('Format de coordonn√©es GPS invalide. Utilisez le format "latitude, longitude"', 'error');
                return;
            }
            
            const title = document.getElementById('title').value;
            const type = document.getElementById('type').value;
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const fromCoordinatesStr = document.getElementById('fromCoordinates').value;
            const toCoordinatesStr = document.getElementById('toCoordinates').value;
            const distance = parseFloat(document.getElementById('distance').value);
            const duration = parseInt(document.getElementById('duration').value);
            const reward = parseInt(document.getElementById('reward').value);
            const difficulty = document.getElementById('difficulty').value;
            const description = document.getElementById('description').value;

            // R√©cup√©rer les √©v√©nements du formulaire
            const events = collectEvents();

            const tripData = {
                title,
                type,
                from,
                to,
                fromCoordinates: {
                    latitude: fromCoords[0],
                    longitude: fromCoords[1]
                },
                toCoordinates: {
                    latitude: toCoords[0],
                    longitude: toCoords[1]
                },
                distance,
                duration,
                reward,
                difficulty,
                description,
                events
            };

            try {
                // Ajouter d'abord le trajet pour obtenir l'ID
                const docRef = await db.collection('trips').add(tripData);
                console.log('Trajet cr√©√© avec ID:', docRef.id);

                // Uploader l'image si pr√©sente
                if (currentTripImageFile) {
                    const imageUrl = await uploadTripImage(currentTripImageFile, docRef.id);
                    if (imageUrl) {
                        // Mettre √† jour le document avec l'URL de l'image
                        await docRef.update({ tripImageUrl: imageUrl });
                        console.log('Image ajout√©e au trajet:', imageUrl);
                    }
                }

                showMessage('Trajet ajout√© avec succ√®s !', 'success');
                document.getElementById('tripForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                currentTripImageFile = null;
                loadTrips();
            } catch (error) {
                showMessage('Erreur lors de l\'ajout du trajet : ' + error.message, 'error');
            }
        });

        // Gestion du formulaire d'√©dition
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Parse GPS coordinates for edit form
            const editFromCoords = document.getElementById('editFromCoordinates').value.split(',').map(coord => parseFloat(coord.trim()));
            const editToCoords = document.getElementById('editToCoordinates').value.split(',').map(coord => parseFloat(coord.trim()));
            
            const fromCoordinatesInput = document.getElementById('editFromCoordinates').value;
            const toCoordinatesInput = document.getElementById('editToCoordinates').value;
            const duration = parseInt(document.getElementById('editDuration').value);
            
            let fromCoords = [48.8566, 2.3522]; // Paris par d√©faut
            if (fromCoordinatesInput) {
                fromCoords = fromCoordinatesInput.split(',').map(coord => parseFloat(coord.trim()));
            }
            
            let toCoords = [43.2965, 5.3698]; // Marseille par d√©faut
            if (toCoordinatesInput) {
                toCoords = toCoordinatesInput.split(',').map(coord => parseFloat(coord.trim()));
            }
            
            // R√©cup√©rer les √©v√©nements du formulaire d'√©dition
            const events = collectEditEvents();
            
            
            const tripData = {
                title: document.getElementById('editTitle').value,
                type: document.getElementById('editType').value,
                from: document.getElementById('editFrom').value,
                to: document.getElementById('editTo').value,
                fromCoordinates: {
                    latitude: fromCoords[0],
                    longitude: fromCoords[1]
                },
                toCoordinates: {
                    latitude: toCoords[0],
                    longitude: toCoords[1]
                },
                distance: parseFloat(document.getElementById('editDistance').value),
                duration: duration,
                reward: parseInt(document.getElementById('editReward').value),
                difficulty: document.getElementById('editDifficulty').value,
                description: document.getElementById('editDescription').value,
                events: events
            };

            try {
                // Uploader une nouvelle image si pr√©sente
                if (editTripImageFile) {
                    const imageUrl = await uploadTripImage(editTripImageFile, currentTripId);
                    if (imageUrl) {
                        tripData.tripImageUrl = imageUrl;
                        console.log('Nouvelle image upload√©e:', imageUrl);
                    }
                }

                await db.collection('trips').doc(currentTripId).update(tripData);
                showMessage('Trajet modifi√© avec succ√®s !', 'success');
                closeEditModal();
                loadTrips();
            } catch (error) {
                showMessage('Erreur lors de la modification du trajet : ' + error.message, 'error');
            }
        });

        // Fonction pour afficher les messages
        function showMessage(message, type) {
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            if (type === 'success') {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
            } else {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }

            setTimeout(() => {
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Fonction pour ouvrir le modal d'√©dition
        function openEditModal(tripId, trip) {
            currentTripId = tripId;
            document.getElementById('editTripId').value = tripId;
            document.getElementById('editTitle').value = trip.title;
            document.getElementById('editType').value = trip.type;
            document.getElementById('editFrom').value = trip.from;
            document.getElementById('editTo').value = trip.to;
            
            // Set coordinates if they exist, otherwise use default values
            if (trip.fromCoordinates) {
                document.getElementById('editFromCoordinates').value = `${trip.fromCoordinates.latitude}, ${trip.fromCoordinates.longitude}`;
            } else {
                document.getElementById('editFromCoordinates').value = '48.8566, 2.3522';
            }
            
            if (trip.toCoordinates) {
                document.getElementById('editToCoordinates').value = `${trip.toCoordinates.latitude}, ${trip.toCoordinates.longitude}`;
            } else {
                document.getElementById('editToCoordinates').value = '43.2965, 5.3698';
            }
            
            document.getElementById('editDistance').value = trip.distance;
            document.getElementById('editDuration').value = trip.duration;
            document.getElementById('editReward').value = trip.reward;
            document.getElementById('editDifficulty').value = trip.difficulty;
            document.getElementById('editDescription').value = trip.description;

            // Afficher l'image actuelle si elle existe
            if (trip.tripImageUrl) {
                document.getElementById('currentImg').src = trip.tripImageUrl;
                document.getElementById('editCurrentImage').style.display = 'block';
            } else {
                document.getElementById('editCurrentImage').style.display = 'none';
            }

            // R√©initialiser les champs d'image
            document.getElementById('editTripImageFile').value = '';
            document.getElementById('editImagePreview').style.display = 'none';
            editTripImageFile = null;
            
            // Vider le conteneur d'√©v√©nements
            const eventsContainer = document.getElementById('editEventsContainer');
            eventsContainer.innerHTML = '';
            
            // Ajouter les √©v√©nements existants
            if (trip.events && trip.events.length > 0) {
                trip.events.forEach(event => {
                    addEventToEditForm(event);
                });
            }

            document.getElementById('editModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }

        // Fonction pour fermer le modal d'√©dition
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentTripId = null;

            // R√©initialiser les variables d'image
            editTripImageFile = null;
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editCurrentImage').style.display = 'none';
        }
        
        // Fonction pour ajouter un √©v√©nement au formulaire d'√©dition
        function addEventToEditForm(eventData = null) {
            const eventsContainer = document.getElementById('editEventsContainer');
            const eventId = eventData?.eventId || uuidv4();
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.dataset.eventId = eventId;
            
            const eventContent = `
                <div class="event-header">
                    <span class="event-title">√âv√©nement</span>
                    <button type="button" class="remove-event">Supprimer</button>
                </div>
                <div class="event-fields">
                    <div>
                        <label for="edit-event-title-${eventId}">Titre</label>
                        <input type="text" id="edit-event-title-${eventId}" class="event-title-input" value="${eventData?.title || ''}" placeholder="Ex: Bouchon, Route barr√©e, etc." required>
                    </div>
                    <div>
                        <label for="edit-event-timing-${eventId}">D√©lai apr√®s d√©part (minutes)</label>
                        <input type="number" id="edit-event-timing-${eventId}" class="event-timing-input" value="${eventData?.timing || '30'}" min="0" required>
                    </div>
                    <div>
                        <label for="edit-event-type-${eventId}">Type</label>
                        <select id="edit-event-type-${eventId}" class="event-type-input">
                            <option value="fixed" ${eventData?.type === 'fixed' ? 'selected' : ''}>Fixe</option>
                            <option value="random" ${eventData?.type === 'random' ? 'selected' : ''}>Al√©atoire</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-event-category-${eventId}">Cat√©gorie</label>
                        <select id="edit-event-category-${eventId}" class="event-category-input">
                            <option value="general" ${!eventData?.category || eventData?.category === 'general' ? 'selected' : ''}>G√©n√©ral</option>
                            <option value="bouchon" ${eventData?.category === 'bouchon' ? 'selected' : ''}>Bouchon</option>
                            <option value="pluie" ${eventData?.category === 'pluie' ? 'selected' : ''}>Pluie</option>
                            <option value="route-barree" ${eventData?.category === 'route-barree' ? 'selected' : ''}>Route barr√©e</option>
                            <option value="colis-mystere" ${eventData?.category === 'colis-mystere' ? 'selected' : ''}>Colis myst√®re</option>
                            <option value="pause-fatigue" ${eventData?.category === 'pause-fatigue' ? 'selected' : ''}>Pause fatigue</option>
                            <option value="pneu-creve" ${eventData?.category === 'pneu-creve' ? 'selected' : ''}>Pneu crev√©</option>
                            <option value="controle-police" ${eventData?.category === 'controle-police' ? 'selected' : ''}>Contr√¥le de police</option>
                            <option value="feu-rouge" ${eventData?.category === 'feu-rouge' ? 'selected' : ''}>Feu rouge</option>
                            <option value="radar" ${eventData?.category === 'radar' ? 'selected' : ''}>Radar</option>
                            <option value="panneaux" ${eventData?.category === 'panneaux' ? 'selected' : ''}>Panneaux routiers</option>
                            <option value="peage" ${eventData?.category === 'peage' ? 'selected' : ''}>P√©age automatique</option>
                            <option value="radio" ${eventData?.category === 'radio' ? 'selected' : ''}>Radio</option>
                        </select>
                    </div>
                </div>
            `;
            
            eventItem.innerHTML = eventContent;
            eventsContainer.appendChild(eventItem);
            
            // Ajouter l'√©couteur d'√©v√©nement pour le bouton de suppression
            eventItem.querySelector('.remove-event').addEventListener('click', function() {
                eventItem.remove();
            });
        }
        
        // Ajouter un √©couteur d'√©v√©nement pour le bouton d'ajout d'√©v√©nement dans le modal d'√©dition
        document.getElementById('editAddEventButton').addEventListener('click', function() {
            addEventToEditForm();
        });
        
        // Fonction pour collecter les √©v√©nements du formulaire d'√©dition
        function collectEditEvents() {
            const events = [];
            const eventItems = document.querySelectorAll('#editEventsContainer .event-item');
            
            eventItems.forEach(item => {
                const eventId = item.dataset.eventId;
                const title = item.querySelector('.event-title-input').value;
                const timing = parseInt(item.querySelector('.event-timing-input').value);
                const type = item.querySelector('.event-type-input').value;
                const category = item.querySelector('.event-category-input').value;
                
                events.push({
                    eventId,
                    title,
                    timing,
                    type,
                    category
                });
            });
            
            return events;
        }

        // Fonction pour supprimer un trajet
        async function deleteTrip(tripId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce trajet ?')) {
                try {
                    await db.collection('trips').doc(tripId).delete();
                    showMessage('Trajet supprim√© avec succ√®s !', 'success');
                    loadTrips();
                } catch (error) {
                    showMessage('Erreur lors de la suppression du trajet : ' + error.message, 'error');
                }
            }
        }

        // Fonction pour obtenir le texte de difficult√©
        function getDifficultyText(difficulty) {
            const difficulties = {
                easy: 'Facile',
                medium: 'Moyen',
                hard: 'Difficile'
            };
            return difficulties[difficulty] || difficulty;
        }

        // Fonction pour obtenir le texte du type
        function getTypeText(type) {
            const types = {
                food: 'Repas',
                package: 'Colis',
                document: 'Document'
            };
            return types[type] || type;
        }

        // Fonction pour charger et afficher les trajets
        async function loadTrips() {
            const tripList = document.getElementById('tripList');
            tripList.innerHTML = '<h2>Trajets existants</h2>';

            try {
                const snapshot = await db.collection('trips').get();
                snapshot.forEach(doc => {
                    const trip = doc.data();
                    const tripElement = document.createElement('div');
                    tripElement.className = 'trip-item';
                    tripElement.innerHTML = `
                        <div class="trip-actions">
                            <button class="action-button edit-button" onclick='openEditModal("${doc.id}", ${JSON.stringify(trip).replace(/'/g, "\\'")})'>Modifier</button>
                            <button class="action-button delete-button" onclick="deleteTrip('${doc.id}')">Supprimer</button>
                        </div>
                        <h3>${trip.title}</h3>
                        <p>
                            <strong>Type:</strong> 
                            <span class="type-badge">${getTypeText(trip.type)}</span>
                        </p>
                        <p><strong>Trajet:</strong> ${trip.from} ‚Üí ${trip.to}</p>
                        <p><strong>Coordonn√©es d√©part:</strong> ${trip.fromCoordinates ? `${trip.fromCoordinates.latitude}, ${trip.fromCoordinates.longitude}` : 'Non sp√©cifi√©es'}</p>
                        <p><strong>Coordonn√©es arriv√©e:</strong> ${trip.toCoordinates ? `${trip.toCoordinates.latitude}, ${trip.toCoordinates.longitude}` : 'Non sp√©cifi√©es'}</p>
                        <p><strong>Distance:</strong> ${trip.distance} km</p>
                        <p><strong>Dur√©e:</strong> ${trip.duration} min</p>
                        <p><strong>P√©nalit√© initiale:</strong> ${trip.initialPenalty || 0} min</p>
                        <p><strong>Heure d'arriv√©e pr√©vue:</strong> ${trip.expectedArrivalTime ? new Date(trip.expectedArrivalTime).toLocaleTimeString() : 'Non sp√©cifi√©e'}</p>
                        <p><strong>Heure d'arriv√©e estim√©e:</strong> ${trip.actualArrivalTime ? new Date(trip.actualArrivalTime).toLocaleTimeString() : 'Non sp√©cifi√©e'}</p>
                        <p><strong>R√©compense:</strong> ${trip.reward} miles</p>
                        <p>
                            <strong>Difficult√©:</strong> 
                            <span class="difficulty-badge difficulty-${trip.difficulty}">${getDifficultyText(trip.difficulty)}</span>
                        </p>
                        <p><strong>Description:</strong> ${trip.description}</p>
                        ${trip.tripImageUrl ? `
                            <div style="margin: 10px 0;">
                                <strong>Image du trajet:</strong><br>
                                <img src="${trip.tripImageUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd; margin-top: 8px;" alt="Image du trajet" />
                            </div>
                        ` : '<p><strong>Image:</strong> Aucune</p>'}
                    <p><strong>√âv√©nements:</strong> ${trip.events ? trip.events.length : 0}</p>
                    `;
                    tripList.appendChild(tripElement);
                });
            } catch (error) {
                showMessage('Erreur lors du chargement des trajets : ' + error.message, 'error');
            }
        }

        // Fermer le modal si on clique en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }

        // =============================================
        // SECTION GESTION DES R√âCOMPENSES
        // =============================================

        // Gestion du formulaire d'ajout de r√©compense
        document.getElementById('rewardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const rewardData = {
                title: document.getElementById('rewardTitle').value,
                subtitle: document.getElementById('rewardSubtitle').value,
                description: document.getElementById('rewardDescription').value,
                cost: parseInt(document.getElementById('rewardCost').value),
                imageUrl: document.getElementById('rewardImageUrl').value || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                unlocked: false
            };
            
            try {
                await db.collection('rewards').add(rewardData);
                showMessage('R√©compense ajout√©e avec succ√®s !', 'success');
                document.getElementById('rewardForm').reset();
                loadRewards();
            } catch (error) {
                showMessage('Erreur lors de l\'ajout de la r√©compense : ' + error.message, 'error');
            }
        });

        // Fonction pour charger et afficher les r√©compenses
        async function loadRewards() {
            const rewardsList = document.getElementById('rewardsList');
            if (!rewardsList) return;
            
            rewardsList.innerHTML = 'Chargement...';
            
            try {
                const snapshot = await db.collection('rewards').orderBy('cost', 'asc').get();
                
                if (snapshot.empty) {
                    rewardsList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Aucune r√©compense configur√©e</p>';
                    return;
                }
                
                let rewardsHtml = '';
                snapshot.forEach(doc => {
                    const reward = doc.data();
                    rewardsHtml += `
                        <div class="reward-item" style="border: 2px solid #e1e1e1; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative;">
                            <div class="reward-actions" style="position: absolute; top: 15px; right: 15px; display: flex; gap: 8px;">
                                <button class="action-button edit-button" onclick="editReward('${doc.id}', ${JSON.stringify(reward).replace(/'/g, "\\'")})" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Modifier</button>
                                <button class="action-button delete-button" onclick="deleteReward('${doc.id}')" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Supprimer</button>
                            </div>
                            <h3 style="margin-bottom: 8px; font-size: 18px; color: #333;">${reward.title}</h3>
                            <p style="color: #666; margin-bottom: 5px; font-size: 14px;"><strong>Sous-titre:</strong> ${reward.subtitle}</p>
                            <p style="color: #666; margin-bottom: 10px; font-size: 14px;"><strong>Description:</strong> ${reward.description}</p>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                    ${reward.cost} points
                                </span>
                                ${reward.imageUrl ? `<span style="color: #4CAF50; font-size: 12px;"><i class="fas fa-image"></i> Image configur√©e</span>` : '<span style="color: #999; font-size: 12px;">Pas d\'image</span>'}
                            </div>
                        </div>
                    `;
                });
                
                rewardsList.innerHTML = rewardsHtml;
            } catch (error) {
                showMessage('Erreur lors du chargement des r√©compenses : ' + error.message, 'error');
                rewardsList.innerHTML = '<p style="color: #f44336; text-align: center; padding: 20px;">Erreur de chargement</p>';
            }
        }

        // Fonction pour supprimer une r√©compense
        async function deleteReward(rewardId) {
            if (confirm('Etes-vous s√ªr de vouloir supprimer cette r√©compense ?')) {
                try {
                    await db.collection('rewards').doc(rewardId).delete();
                    showMessage('R√©compense supprim√©e avec succ√®s !', 'success');
                    loadRewards();
                } catch (error) {
                    showMessage('Erreur lors de la suppression : ' + error.message, 'error');
                }
            }
        }

        // Fonction pour √©diter une r√©compense (simplified version - ouvre un prompt)
        function editReward(rewardId, rewardData) {
            const newCost = prompt('Nouveau co√ªt en points:', rewardData.cost);
            if (newCost && !isNaN(newCost)) {
                updateReward(rewardId, { cost: parseInt(newCost) });
            }
        }

        // Fonction pour mettre √† jour une r√©compense
        async function updateReward(rewardId, updates) {
            try {
                await db.collection('rewards').doc(rewardId).update(updates);
                showMessage('R√©compense mise √† jour avec succ√®s !', 'success');
                loadRewards();
            } catch (error) {
                showMessage('Erreur lors de la mise √† jour : ' + error.message, 'error');
            }
        }

        // Fonction pour initialiser les r√©compenses par d√©faut
        async function initializeDefaultRewards() {
            const defaultRewards = [
                {
                    title: 'R√©COMPENSE BRONZE',
                    subtitle: 'Votre premi√®re r√©compense !',
                    description: 'F√©licitations ! Vous avez d√©bloqu√© votre premi√®re r√©compense. Cette r√©compense marque le d√©but de votre parcours et montre votre engagement.',
                    cost: 200,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    title: 'R√©COMPENSE ARGENT',
                    subtitle: 'Un niveau sup√©rieur atteint !',
                    description: 'Excellente progression ! Vous montrez une r√©gularit√© impressionnante dans vos trajets. Cette r√©compense t√©moigne de votre d√©termination.',
                    cost: 400,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    title: 'R√©COMPENSE OR',
                    subtitle: 'Performance exceptionnelle !',
                    description: 'Incroyable ! Vous faites partie des meilleurs conducteurs Vago. Votre expertise et votre constance sont remarquables.',
                    cost: 600,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    title: 'R√©COMPENSE PLATINE',
                    subtitle: 'Ma√Ætrise absolue !',
                    description: 'Extraordinaire ! Vous avez atteint un niveau de ma√Ætrise exceptionnel. Peu de conducteurs atteignent ce niveau d\'excellence.',
                    cost: 800,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    title: 'R√©COMPENSE DIAMANT',
                    subtitle: 'L√©gende vivante !',
                    description: 'Ph√©nom√©nal ! Vous √™tes maintenant une l√©gende de Vago. Votre d√©vouement et vos comp√©tences inspirent tous les autres conducteurs.',
                    cost: 1000,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    title: 'R√âCOMPENSE ULTIME',
                    subtitle: 'Le sommet de l\'excellence !',
                    description: 'L√©gendaire ! Vous avez atteint l\'apog√©e de l\'excellence sur Vago. Cette r√©compense ultime couronne un parcours absolument remarquable.',
                    cost: 1200,
                    imageUrl: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];

            try {
                // Supprimer les anciennes r√©compenses
                const oldRewards = await db.collection('rewards').get();
                const deletePromises = oldRewards.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);

                // Ajouter les nouvelles r√©compenses
                const addPromises = defaultRewards.map(reward => 
                    db.collection('rewards').add(reward)
                );
                await Promise.all(addPromises);

                showMessage(`üèÜ ${defaultRewards.length} r√©compenses par d√©faut cr√©√©es avec succ√®s !`, 'success');
                loadRewards();
            } catch (error) {
                showMessage('Erreur lors de l\'initialisation des r√©compenses : ' + error.message, 'error');
            }
        }

        // =============================================
        // SECTION GESTION DES OBJETS
        // =============================================

        // Fonction pour initialiser les objets de base
        async function initializeBaseItems() {
            const baseItems = [
                // === OBJETS TEMPORELS - R√âDUCTION DE P√âNALIT√âS ===

                // 1. MICRO BOOST - Retire 1 minute de p√©nalit√©
                {
                    id: 'micro-boost',
                    name: 'Micro Boost',
                    description: 'Un petit coup de pouce qui vous fait gagner 1 minute pr√©cieuse !',
                    rarity: 'common',
                    icon: 'flash',
                    category: 'boost',
                    usageEffect: {
                        type: 'time_reduction',
                        target: 'estimated_time',
                        value: -1,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.18
                },
                // 2. TURBO L√âGER - Retire 3 minutes de p√©nalit√©
                {
                    id: 'turbo-leger',
                    name: 'Turbo L√©ger',
                    description: 'Un turbo discret mais efficace qui vous fait gagner 3 bonnes minutes !',
                    rarity: 'common',
                    icon: 'speedometer',
                    category: 'boost',
                    usageEffect: {
                        type: 'time_reduction',
                        target: 'estimated_time',
                        value: -3,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.15
                },
                // 3. TURBO EXPRESS - Retire 5 minutes de p√©nalit√©
                {
                    id: 'turbo-express',
                    name: 'Turbo Express',
                    description: 'Un boost costaud qui vous fait grappiller 5 pr√©cieuses minutes !',
                    rarity: 'rare',
                    icon: 'rocket',
                    category: 'boost',
                    usageEffect: {
                        type: 'time_reduction',
                        target: 'estimated_time',
                        value: -5,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.12
                },
                // 4. NITRO TEMPOREL - Retire 10 minutes de p√©nalit√©
                {
                    id: 'nitro-temporel',
                    name: 'Nitro Temporel',
                    description: 'Un boost surpuissant qui vous fait gagner 10 minutes comme par magie !',
                    rarity: 'epic',
                    icon: 'thunderstorm',
                    category: 'special',
                    usageEffect: {
                        type: 'time_reduction',
                        target: 'estimated_time',
                        value: -10,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.08
                },

                // === OBJETS SP√âCIAUX ===

                // 5. MACHINE √Ä REMONTER LE TEMPS - L√®ve toutes les p√©nalit√©s
                {
                    id: 'delorean-flux',
                    name: 'DeLorean Flux',
                    description: 'Retour vers le futur ! Annule compl√®tement tout votre retard d\'un coup !',
                    rarity: 'legendary',
                    icon: 'time',
                    category: 'special',
                    usageEffect: {
                        type: 'time_reset',
                        target: 'catch_up_delay',
                        value: 0,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.01
                },
                // 6. PASSE-PARTOUT VIP - R√©sout instantan√©ment un √©v√©nement
                {
                    id: 'passe-partout',
                    name: 'Passe-Partout VIP',
                    description: 'Carte blanche qui vous permet de zapper n\'importe quel probl√®me sur la route !',
                    rarity: 'legendary',
                    icon: 'shield-checkmark',
                    category: 'special',
                    usageEffect: {
                        type: 'event_skip',
                        target: 'any_event',
                        value: 1,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.02
                },

                // === OBJETS JAUGES - ESSENCE ===

                // 7. PETIT BIDON - Ajoute 1 barre d'essence
                {
                    id: 'petit-bidon',
                    name: 'Petit Bidon',
                    description: 'Un petit bidon d\'essence d\'urgence qui vous donne 1 barre suppl√©mentaire !',
                    rarity: 'common',
                    icon: 'water',
                    category: 'consumable',
                    usageEffect: {
                        type: 'gauge_boost',
                        target: 'fuel',
                        value: 20,  // 1 barre d'essence (20/20 = 1)
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.16
                },
                // 8. PLEIN SUPER - Remet au maximum les barres d'essence
                {
                    id: 'plein-super',
                    name: 'Plein Super',
                    description: 'Un plein d\'essence premium qui recharge compl√®tement votre r√©servoir !',
                    rarity: 'rare',
                    icon: 'car',
                    category: 'boost',
                    usageEffect: {
                        type: 'gauge_boost',
                        target: 'fuel',
                        value: 100,  // 5 barres d'essence (100/20 = 5)
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.10
                },

                // === OBJETS JAUGES - √âNERGIE SOMMEIL ===

                // 9. EXPRESSO - Ajoute 1 barre d'√©nergie
                {
                    id: 'expresso',
                    name: 'Expresso',
                    description: 'Un caf√© bien serr√© qui vous redonne 1 niveau d\'√©nergie instantan√©ment !',
                    rarity: 'common',
                    icon: 'cafe',
                    category: 'consumable',
                    usageEffect: {
                        type: 'gauge_boost',
                        target: 'energy',
                        value: 20,  // 1 niveau d'√©nergie (20/20 = 1)
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.16
                },
                // 10. RED BULL MAX - Remet au maximum les barres d'√©nergie
                {
                    id: 'red-bull-max',
                    name: 'Red Bull MAX',
                    description: 'La boisson √©nergisante ultime qui vous recharge compl√®tement ! Vous avez des ailes !',
                    rarity: 'rare',
                    icon: 'battery-charging',
                    category: 'consumable',
                    usageEffect: {
                        type: 'gauge_boost',
                        target: 'energy',
                        value: 100,  // 5 niveaux d'√©nergie (100/20 = 5)
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.10
                },

                // === OBJETS UTILES BONUS ===

                // 11. BONUS MILES - R√©compense bonus
                {
                    id: 'client-satisfait',
                    name: 'Client Satisfait',
                    description: 'Un client g√©n√©reux qui vous file un pourboire de ouf √† l\'arriv√©e !',
                    rarity: 'rare',
                    icon: 'gift',
                    category: 'special',
                    usageEffect: {
                        type: 'reward_bonus',
                        target: 'end_bonus',
                        value: 4,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.08
                },

                // === OBJETS INUTILES MAIS DR√îLES ===

                // 12. OBJET INUTILE - Parfum voiture
                {
                    id: 'sapin-magique',
                    name: 'Sapin Magique',
                    description: 'Un petit sapin qui sent bon... mais c\'est tout. Absolument inutile pour votre trajet',
                    rarity: 'common',
                    icon: 'leaf',
                    category: 'inutile',
                    usageEffect: {
                        type: 'useless',
                        target: 'nothing',
                        value: 0,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.12
                },
                // 13. OBJET INUTILE - D√©s fluffy
                {
                    id: 'des-fluffy',
                    name: 'D√©s Fluffy',
                    description: 'Des d√©s tout moelleux √† suspendre au r√©tro. Tr√®s mignon, totalement inutile',
                    rarity: 'common',
                    icon: 'dice',
                    category: 'inutile',
                    usageEffect: {
                        type: 'useless',
                        target: 'nothing',
                        value: 0,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.11
                },
                // 14. OBJET INUTILE - Bobblehead
                {
                    id: 'bobblehead-vago',
                    name: 'Bobblehead Vago',
                    description: 'Une figurine qui hoche la t√™te sur le tableau de bord. Hypnotisant mais inutile',
                    rarity: 'rare',
                    icon: 'happy',
                    category: 'inutile',
                    usageEffect: {
                        type: 'useless',
                        target: 'nothing',
                        value: 0,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.06
                },
                // 15. OBJET INUTILE - Klaxon canard
                {
                    id: 'klaxon-canard',
                    name: 'Klaxon Canard',
                    description: 'Fait "coin coin" au lieu de "bip bip". Hilarant mais ne sert strictement √† rien',
                    rarity: 'epic',
                    icon: 'musical-notes',
                    category: 'inutile',
                    usageEffect: {
                        type: 'useless',
                        target: 'nothing',
                        value: 0,
                        duration: 0
                    },
                    isConsumable: true,
                    spawnRate: 0.03
                }
            ];

            try {
                console.log('üöÄ Initialisation des nouveaux objets Vago (sympas + inutiles)...');
                
                // Supprimer tous les anciens objets
                const oldItemsSnapshot = await db.collection('items').get();
                const deletePromises = oldItemsSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                console.log('üóëÔ∏è Anciens objets supprim√©s');
                
                // Ajouter les nouveaux objets
                for (const item of baseItems) {
                    await db.collection('items').doc(item.id).set({
                        name: item.name,
                        description: item.description,
                        rarity: item.rarity,
                        icon: item.icon,
                        category: item.category,
                        usageEffect: item.usageEffect,
                        isConsumable: item.isConsumable,
                        spawnRate: item.spawnRate
                    });
                    
                    console.log(`‚úÖ Objet ajout√©: ${item.name} (${item.rarity})`);
                }
                
                showMessage(`üéâ ${baseItems.length} nouveaux objets Vago cr√©√©s avec succ√®s !
                ‚ö° ${baseItems.filter(i => i.usageEffect.type === 'time_reduction').length} objets temporels
                üõ†Ô∏è ${baseItems.filter(i => i.usageEffect.target === 'fuel' || i.usageEffect.target === 'energy').length} objets de jauges
                üé≠ ${baseItems.filter(i => i.category === 'inutile').length} objets inutiles mais dr√¥les`, 'success');
                loadItems(); // Recharger la liste des objets
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                showMessage('Erreur lors de l\'initialisation des objets : ' + error.message, 'error');
            }
        }

        // Fonction pour charger et afficher les objets
        async function loadItems() {
            const itemList = document.getElementById('itemList');
            if (!itemList) return;
            
            itemList.innerHTML = '<h2>Objets existants</h2>';

            try {
                const snapshot = await db.collection('items').get();
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const itemElement = document.createElement('div');
                    itemElement.className = 'trip-item';
                    
                    const rarityClass = `difficulty-${item.rarity === 'legendary' ? 'hard' : item.rarity === 'epic' ? 'medium' : 'easy'}`;
                    
                    itemElement.innerHTML = `
                        <div class="trip-actions">
                            <button class="action-button edit-button" onclick="editItem('${doc.id}', ${JSON.stringify(item).replace(/'/g, "\\'")})" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Modifier</button>
                            <button class="action-button delete-button" onclick="deleteItem('${doc.id}')" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Supprimer</button>
                        </div>
                        <h3>${item.name}</h3>
                        <p>
                            <strong>Raret√©:</strong> 
                            <span class="difficulty-badge ${rarityClass}">${item.rarity.toUpperCase()}</span>
                        </p>
                        <p><strong>Cat√©gorie:</strong> ${item.category}</p>
                        <p><strong>Ic√¥ne:</strong> ${item.icon}</p>
                        <p><strong>Description:</strong> ${item.description}</p>
                        <p><strong>Taux d'apparition:</strong> ${(item.spawnRate * 100).toFixed(1)}%</p>
                        <p><strong>Effet:</strong> ${item.usageEffect.type} ‚Üí ${item.usageEffect.target} (${item.usageEffect.value})</p>
                        <p><strong>Consommable:</strong> ${item.isConsumable ? 'Oui' : 'Non'}</p>
                    `;
                    itemList.appendChild(itemElement);
                });
            } catch (error) {
                showMessage('Erreur lors du chargement des objets : ' + error.message, 'error');
            }
        }

        // Fonction pour √©diter un objet
        function editItem(itemId, itemData) {
            // Modal simple pour √©diter les propri√©t√©s principales
            const newName = prompt('Nouveau nom:', itemData.name);
            if (newName && newName !== itemData.name) {
                updateItem(itemId, { name: newName });
                return;
            }
            
            const newDescription = prompt('Nouvelle description:', itemData.description);
            if (newDescription && newDescription !== itemData.description) {
                updateItem(itemId, { description: newDescription });
                return;
            }
            
            const newSpawnRate = prompt('Nouveau taux d\'apparition (0-1):', itemData.spawnRate);
            if (newSpawnRate && !isNaN(newSpawnRate) && newSpawnRate !== itemData.spawnRate.toString()) {
                updateItem(itemId, { spawnRate: parseFloat(newSpawnRate) });
                return;
            }
        }

        // Fonction pour mettre √† jour un objet
        async function updateItem(itemId, updates) {
            try {
                await db.collection('items').doc(itemId).update(updates);
                showMessage('Objet mis √† jour avec succ√®s !', 'success');
                loadItems();
            } catch (error) {
                showMessage('Erreur lors de la mise √† jour : ' + error.message, 'error');
            }
        }

        // Fonction pour supprimer un objet
        async function deleteItem(itemId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet objet ?')) {
                try {
                    await db.collection('items').doc(itemId).delete();
                    showMessage('Objet supprim√© avec succ√®s !', 'success');
                    loadItems();
                } catch (error) {
                    showMessage('Erreur lors de la suppression de l\'objet : ' + error.message, 'error');
                }
            }
        }

        // Les onglets sont maintenant g√©r√©s par la fonction showTab() d√©finie plus haut

        // =============================================
        // SECTION GESTION DES DEMANDES DE R√âCOMPENSES
        // =============================================

        let allRewardClaims = [];
        let filteredClaims = [];
        let currentFilter = 'all';
        let currentEditClaimId = null;

        // Charger toutes les demandes de r√©compenses
        async function loadRewardClaims() {
            try {
                const claimsSnapshot = await db.collection('reward-claims')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allRewardClaims = [];
                claimsSnapshot.forEach(doc => {
                    allRewardClaims.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                filteredClaims = [...allRewardClaims];
                displayRewardClaims();
                loadRewardClaimStats();
                
            } catch (error) {
                console.error('Erreur lors du chargement des demandes:', error);
                document.getElementById('rewardClaimsList').innerHTML = '<p style="color: #f44336; text-align: center; padding: 40px;">Erreur de chargement</p>';
            }
        }

        // Charger les statistiques des demandes
        async function loadRewardClaimStats() {
            try {
                const stats = {
                    total: allRewardClaims.length,
                    pending: allRewardClaims.filter(c => c.status === 'pending').length,
                    approved: allRewardClaims.filter(c => c.status === 'approved').length,
                    rejected: allRewardClaims.filter(c => c.status === 'rejected').length,
                    in_preparation: allRewardClaims.filter(c => c.status === 'in_preparation').length,
                    shipped: allRewardClaims.filter(c => c.status === 'shipped').length,
                    delivered: allRewardClaims.filter(c => c.status === 'delivered').length
                };

                const statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.total}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);">
                            <div class="stat-number">${stats.pending}</div>
                            <div class="stat-label">En attente</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <div class="stat-number">${stats.approved}</div>
                            <div class="stat-label">Approuv√©es</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                            <div class="stat-number">${stats.rejected}</div>
                            <div class="stat-label">Rejet√©es</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
                            <div class="stat-number">${stats.in_preparation}</div>
                            <div class="stat-label">En pr√©paration</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                            <div class="stat-number">${stats.shipped}</div>
                            <div class="stat-label">Exp√©di√©es</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #20c997 0%, #0dcaf0 100%);">
                            <div class="stat-number">${stats.delivered}</div>
                            <div class="stat-label">Livr√©es</div>
                        </div>
                    </div>
                `;

                document.getElementById('rewardClaimStats').innerHTML = statsHtml;
            } catch (error) {
                console.error('Erreur lors du calcul des statistiques:', error);
                document.getElementById('rewardClaimStats').innerHTML = '<p>Erreur lors du calcul des statistiques</p>';
            }
        }

        // Filtrer les demandes par statut
        function filterClaimsByStatus(status) {
            currentFilter = status;
            
            // Mettre √† jour les boutons de filtre
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('filter' + status.charAt(0).toUpperCase() + status.slice(1).replace('_', '')).classList.add('active');

            // Filtrer les demandes
            if (status === 'all') {
                filteredClaims = [...allRewardClaims];
            } else {
                filteredClaims = allRewardClaims.filter(claim => claim.status === status);
            }

            displayRewardClaims();
        }

        // Afficher les demandes filtr√©es
        function displayRewardClaims() {
            const claimsList = document.getElementById('rewardClaimsList');
            
            if (!filteredClaims || filteredClaims.length === 0) {
                claimsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>Aucune demande trouv√©e pour ce filtre</p>
                    </div>
                `;
                return;
            }

            let claimsHtml = '';
            filteredClaims.forEach(claim => {
                const createdDate = claim.createdAt?.toDate ? claim.createdAt.toDate().toLocaleString('fr-FR') : 'Date inconnue';
                const updatedDate = claim.updatedAt?.toDate ? claim.updatedAt.toDate().toLocaleString('fr-FR') : createdDate;
                
                claimsHtml += `
                    <div class="claim-item" data-claim-id="${claim.id}">
                        <div class="claim-header">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #333;">#${claim.id.substring(0, 8).toUpperCase()}</h4>
                                <span class="claim-status-badge claim-status-${claim.status}">${getStatusLabel(claim.status)}</span>
                            </div>
                            <div class="claim-actions">
                                <button class="action-button details-button" onclick="showClaimDetails('${claim.id}')" style="background: #17a2b8;">
                                    <i class="fas fa-info-circle"></i> D√©tails
                                </button>
                                ${claim.status === 'pending' ? `
                                    <button class="action-button approve-button" onclick="quickApprove('${claim.id}')" style="background: #28a745;">
                                        <i class="fas fa-check"></i> Approuver
                                    </button>
                                    <button class="action-button reject-button" onclick="quickReject('${claim.id}')" style="background: #dc3545;">
                                        <i class="fas fa-times"></i> Rejeter
                                    </button>
                                ` : `
                                    <button class="action-button edit-button" onclick="editRewardClaimStatus('${claim.id}')">
                                        <i class="fas fa-edit"></i> Changer statut
                                    </button>
                                `}
                            </div>
                        </div>

                        <div class="claim-reward-summary">
                            <strong>${claim.rewardTitle}</strong> - ${claim.pointsCost} points
                            <br><small style="color: #666;">${claim.userPseudo} (${claim.userEmail})</small>
                        </div>

                        <div class="claim-quick-info">
                            <p><strong>üìÖ Demand√© le:</strong> ${createdDate}</p>
                            <p><strong>üìç Livraison:</strong> ${claim.personalInfo.ville} (${claim.personalInfo.codePostal})</p>
                        </div>

                        ${claim.adminNotes ? `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107; margin-top: 10px;">
                                <strong>Notes administratives:</strong><br>
                                ${claim.adminNotes}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            claimsList.innerHTML = claimsHtml;
        }

        // Obtenir le libell√© du statut
        function getStatusLabel(status) {
            const labels = {
                'pending': 'En attente',
                'approved': 'Approuv√©e',
                'rejected': 'Rejet√©e',
                'in_preparation': 'En pr√©paration',
                'shipped': 'Exp√©di√©e',
                'delivered': 'Livr√©e'
            };
            return labels[status] || status;
        }

        // Ouvrir le modal d'√©dition du statut
        function editRewardClaimStatus(claimId) {
            currentEditClaimId = claimId;
            const claim = allRewardClaims.find(c => c.id === claimId);
            
            if (!claim) {
                alert('Demande non trouv√©e');
                return;
            }

            // Remplir les informations
            document.getElementById('editClaimId').value = claimId;
            document.getElementById('editClaimStatus').value = claim.status;
            document.getElementById('editClaimNotes').value = claim.adminNotes || '';
            
            // Afficher les informations de l'utilisateur
            document.getElementById('claimUserInfo').innerHTML = `
                <strong>${claim.userPseudo}</strong><br>
                ${claim.userEmail}<br>
                <small>ID: ${claim.userId}</small>
            `;

            // Afficher les informations de la r√©compense
            document.getElementById('claimRewardInfo').innerHTML = `
                <strong>${claim.rewardTitle}</strong><br>
                ${claim.rewardSubtitle}<br>
                <span style="color: #667eea; font-weight: 600;">${claim.pointsCost} points</span>
            `;

            // Afficher les informations personnelles
            document.getElementById('claimPersonalInfo').innerHTML = `
                <strong>Nom complet:</strong> ${claim.personalInfo.prenom} ${claim.personalInfo.nom}<br>
                <strong>T√©l√©phone:</strong> ${claim.personalInfo.telephone}<br>
                <strong>Adresse:</strong> ${claim.personalInfo.adresse || 
                  (claim.personalInfo.numeroRue && claim.personalInfo.nomRue ? 
                    claim.personalInfo.numeroRue + ' ' + claim.personalInfo.nomRue : 
                    'Adresse non sp√©cifi√©e')}<br>
                ${claim.personalInfo.codePostal} ${claim.personalInfo.ville}<br>
                ${claim.personalInfo.batiment ? '<strong>B√¢timent/Autres:</strong> ' + claim.personalInfo.batiment + '<br>' : ''}
                ${claim.personalInfo.informationsComplementaires ? '<strong>Infos compl√©mentaires:</strong> ' + claim.personalInfo.informationsComplementaires : ''}
            `;

            document.getElementById('editRewardClaimModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }

        // Fermer le modal d'√©dition
        function closeRewardClaimModal() {
            document.getElementById('editRewardClaimModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentEditClaimId = null;
        }

        // Gestion du formulaire de modification du statut
        document.getElementById('rewardClaimStatusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditClaimId) {
                alert('Aucune demande s√©lectionn√©e');
                return;
            }

            const newStatus = document.getElementById('editClaimStatus').value;
            const adminNotes = document.getElementById('editClaimNotes').value.trim();

            try {
                // Mettre √† jour le statut dans Firebase
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (adminNotes) {
                    updateData.adminNotes = adminNotes;
                }

                await db.collection('reward-claims').doc(currentEditClaimId).update(updateData);

                // Mettre √† jour localement
                const claimIndex = allRewardClaims.findIndex(c => c.id === currentEditClaimId);
                if (claimIndex !== -1) {
                    allRewardClaims[claimIndex].status = newStatus;
                    allRewardClaims[claimIndex].adminNotes = adminNotes;
                }

                showMessage('Statut mis √† jour avec succ√®s !', 'success');
                closeRewardClaimModal();
                
                // Recharger l'affichage
                filterClaimsByStatus(currentFilter);
                loadRewardClaimStats();

            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showMessage('Erreur lors de la mise √† jour du statut : ' + error.message, 'error');
            }
        });

        // Fermer le modal si on clique en dehors
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editRewardClaimModal');
            if (event.target === modal) {
                closeRewardClaimModal();
            }
        });

        // NOUVELLES FONCTIONS POUR AM√âLIORER LA GESTION

        // Fonction pour afficher le modal avec tous les d√©tails
        function showClaimDetails(claimId) {
            editRewardClaimStatus(claimId);
            // Fermer automatiquement apr√®s avoir affich√©
            // L'utilisateur peut maintenant voir tous les d√©tails
        }

        // Fonction pour approuver rapidement une demande
        async function quickApprove(claimId) {
            if (confirm('Approuver cette demande de r√©compense ?')) {
                try {
                    await db.collection('reward-claims').doc(claimId).update({
                        status: 'approved',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        adminNotes: 'Demande approuv√©e automatiquement'
                    });

                    // Mettre √† jour localement
                    const claimIndex = allRewardClaims.findIndex(c => c.id === claimId);
                    if (claimIndex !== -1) {
                        allRewardClaims[claimIndex].status = 'approved';
                        allRewardClaims[claimIndex].adminNotes = 'Demande approuv√©e automatiquement';
                    }

                    showMessage('‚úÖ Demande approuv√©e avec succ√®s !', 'success');
                    
                    // Recharger l'affichage
                    filterClaimsByStatus(currentFilter);
                    loadRewardClaimStats();

                } catch (error) {
                    console.error('Erreur lors de l\'approbation:', error);
                    showMessage('Erreur lors de l\'approbation : ' + error.message, 'error');
                }
            }
        }

        // Fonction pour rejeter rapidement une demande
        async function quickReject(claimId) {
            const reason = prompt('Raison du rejet (optionnel):');
            if (reason !== null) { // L'utilisateur n'a pas annul√©
                try {
                    await db.collection('reward-claims').doc(claimId).update({
                        status: 'rejected',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        adminNotes: reason || 'Demande rejet√©e'
                    });

                    // Mettre √† jour localement
                    const claimIndex = allRewardClaims.findIndex(c => c.id === claimId);
                    if (claimIndex !== -1) {
                        allRewardClaims[claimIndex].status = 'rejected';
                        allRewardClaims[claimIndex].adminNotes = reason || 'Demande rejet√©e';
                    }

                    showMessage('‚ùå Demande rejet√©e', 'success');
                    
                    // Recharger l'affichage
                    filterClaimsByStatus(currentFilter);
                    loadRewardClaimStats();

                } catch (error) {
                    console.error('Erreur lors du rejet:', error);
                    showMessage('Erreur lors du rejet : ' + error.message, 'error');
                }
            }
        }
    </script>

    <style>
        .init-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .init-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .tab-content {
            min-height: 500px;
        }
        
        .reward-item {
            transition: all 0.3s ease;
        }
        
        .reward-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        /* Styles pour les demandes de r√©compenses */
        .filter-button {
            background: #f8f9fa;
            border: 2px solid #e1e1e1;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            width: auto;
            margin: 0;
        }
        
        .filter-button:hover {
            background: #e9ecef;
            transform: none;
        }
        
        .filter-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .claim-item {
            background: #fff;
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .claim-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .claim-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .claim-status-pending { background: #fff3cd; color: #856404; }
        .claim-status-approved { background: #d4edda; color: #155724; }
        .claim-status-rejected { background: #f8d7da; color: #721c24; }
        .claim-status-in_preparation { background: #cce7ff; color: #0056b3; }
        .claim-status-shipped { background: #e2e3e5; color: #383d41; }
        .claim-status-delivered { background: #d1ecf1; color: #0c5460; }
        
        .claim-actions {
            display: flex;
            gap: 8px;
        }
        
        .claim-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .claim-info-item {
            font-size: 14px;
        }
        
        .claim-info-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .claim-info-value {
            color: #666;
        }
        
        .claim-reward-summary {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</body>
</html> 
